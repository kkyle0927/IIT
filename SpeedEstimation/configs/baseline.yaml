# =============================================================================
# Shared Configurations (Anchors)
# =============================================================================
shared:
  src_h5: &SRC_H5_PATH "./combined_data.h5"
  dst_h5: &DST_H5_PATH "combined_data_speed_diff.h5"
  
  # [CRITICAL] Subject and Condition Lists
  subjects: &SUBJECTS ["S001", "S002", "S003", "S004"]
  conditions: &CONDITIONS ["level", "stopandgo"]
  
  # [CRITICAL] Input/Output Variable Definitions
  # Format: ["group_path", ["column1", "column2", ...]] 
  # These paths are RELATIVE to trial_group in HDF5 (e.g. S001/level/lv0/trial_01/)
  input_vars: &INPUT_VARS
    - ["mocap/kin_q", ["hip_flexion_l", "hip_flexion_r", "knee_angle_l", "knee_angle_r", "ankle_angle_l", "ankle_angle_r"]]
  
  output_vars: &OUTPUT_VARS
    - ["treadmill/left", ["speed_leftbelt"]]
  
  data: &DATA_CONFIG
    window_size: 200  # 2.0s Window
    stride: 5         # [FIX] 50ms Stride (Reduce overlap)
    stride_inf: 1
    y_delay: 5 
    est_tick_ranges: [5] # [FIX] Explicitly predict 5th tick (50ms ahead)
    normalize: True
    time_window_output: 1 # [FIX] Single scalar output
    
  model: &NN_MODEL 
    type: "TCN"               # [NEW] Model Type: TCN, StanceGatedTCN, AttentionTCN
    channels: [16, 16, 32, 32] 
    kernel_size: 7
    dropout: 0.5              
    use_norm: True            
    head_hidden: [32]         
    head_dropout: 0.5         
    model_norm: "layer"
    
    # [Advanced Model Options]
    gating_signal: null       # For StanceGatedTCN (e.g. "contact")
    attention_type: null      # For AttentionTCN (e.g. "temporal")
    attention_heads: 0

# ... (Safety Warning preserved) ...

# ...
# 02. Train Configuration
# =============================================================================
02_train:
  # ...
  
  "data": 
    # Inherit from anchor but allow overrides
    <<: *DATA_CONFIG
    
    # [Advanced Data Options]
    "normalize_type": "standard"           # Options: "standard", "leg_length_scaled"
    "use_physical_velocity_model": False   # If True, use L * theta_dot * cos(theta)
    "use_gait_phase": False                # If True, generate gait phase 0~1
  
  # ...

  "model": *NN_MODEL
  
  "train":
    "task_type": "regression"  
    "loss": "mse"              
    # ...
    # [Advanced Loss Options]
    "loss_penalty": null                   # Options: "frequency_cutoff_penalty"
    "loss_penalty_weight": 0.0
    "loss_penalty_cutoff": null
    
    "epochs": 100
    # ...
    "lr": 0.001                 # [GRID-BEST] 1e-3
    "wd": 0.01                  # [GRID-BEST] 1e-2
    "amp": True
    "device": "cuda"
    "save_dir": "./runs_tcn"
    # Early stopping options
    "early_stop_patience": 10     # 개선이 없으면 20 epoch 후 정지
    "early_stop_min_delta": 1e-03  # 이만큼(초)과 더 작아져야 '개선'으로 인정
    "early_stop_warmup": 5        # 초기 5 epoch은 ES 체크 안 함
    "k_fold": 4
    "train_loss_target": 0.0 
    
    # [NEW] Domain Knowledge Loss (Kinematic Chain) - Added as per request
    "kinematic_loss_weight_pos": 0.0 # [OPTIONAL] Physics constraint
    
    # [NEW] Data Augmentation
    "augment_noise_std": 0.0 # Standard Deviation of Gaussian Noise (0.0 = Disabled)
    "kinematic_loss_weight_limit": 0   # 관절 가동 범위 제약 (추천: 1~10)
    "kinematic_loss_degrees": False
    "kinematic_loss_tolerance": 0.05
    
    smoothness_loss_weight: 0.0   # [NEW] TV Loss for output stability
    
    # Scheduler Params (Retained)
    "cos_T0": 10
    "cos_Tmult": 1
    "eta_min": 0.00001
    
# =============================================================================
# 03. Evaluation Configuration
# =============================================================================
03_eval:
  "io_h5": *DST_H5_PATH
  "split":
    "mode": "manual" # "manual"
    "level": "subject"
    "seed": 42
    "ratio": [0.7, 0.15, 0.15]
    "manual": 
      "test": ["S001"] # select subjects used in training for quick eval
    "save_to": Null
  
  "data": *DATA_CONFIG
  
  "train": 
    "device": "cuda" 

  "scaler_path": "./runs_tcn/scaler.npz"
